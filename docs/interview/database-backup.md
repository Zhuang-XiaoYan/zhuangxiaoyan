---
lang: zh-CN
sidebarDepth: 2
---

# 数据库与缓存一致性

<img :src="$withBase('/interview/cache00.png')" alt="cache-db">

## 一、为什么要引入缓存？

如果你的业务处于起步阶段，流量非常小，那无论是读请求还是写请求，直接操作数据库即可，这时你的架构模型是这样的：

<img :src="$withBase('/interview/cache01.webp')" alt="cache01">

但随着业务量的增长，你的项目请求量越来越大，这时如果每次都从数据库中读数据，那肯定会有性能问题。
这个阶段通常的做法是，引入「缓存」来提高读性能，架构模型就变成了这样：

<img :src="$withBase('/interview/cache02.webp')" alt="cache02">

当下优秀的缓存中间件，当属 Redis 莫属，它不仅性能非常高，还提供了很多友好的数据类型，可以很好地满足我们的业务需求。
但引入缓存之后，你就会面临一个问题：之前数据只存在数据库中，现在要放到缓存中读取，具体要怎么存呢？

最简单直接的方案是**全量数据刷到缓存中**：

* 数据库的数据，全量刷入缓存（不设置失效时间）
* 写请求只更新数据库，不更新缓存
* 启动一个定时任务，定时把数据库的数据，更新到缓存中

<img :src="$withBase('/interview/cache03.webp')" alt="cache03">

这个方案的优点是，所有读请求都可以直接「命中」缓存，不需要再查数据库，性能非常高。但缺点也很明显，有2个问题：
1. 缓存利用率低：不经常访问的数据，还一直留在缓存中
2. 数据不一致：因为是「定时」刷新缓存，缓存和数据库存在不一致（取决于定时任务的执行频率）

所以，这种方案一般更适合业务「体量小」，且对数据一致性要求不高的业务场景。

## 二、缓存利用率和一致性问题

https://zhuanlan.zhihu.com/p/408515044